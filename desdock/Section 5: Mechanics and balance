# 5. Механика и баланс

> Цель раздела — зафиксировать, **как именно работает игра на уровне решений и последствий** в прототипе: что такое типы заявок, кто и почему побеждает/проигрывает, как развивается хаос в героях, какие ограничения действуют на выборы, и какие параметры понадобятся в JSON (TaskRule) для реализации.

---

## 5.1. Базовые принципы (MVP/прототип)

- **Игрок — канцелярский дух**. Он не бегает по подземельям, а **назначает исполнителей** и фиксирует последствия.
- **Исходы детерминированы выбором героя** (на старте): успех/провал/хаос зависят **только** от выбранного исполнителя и сценария (в дальнейшем — от перков героя).
- **Хаос — не глобальная шкала, а персональная арка героя**. Чем больше хаотичных решений выполняет конкретный герой, тем сильнее он меняется (визуально, в репликах, в доступных ветках магограммы).
- **Ограничения — часть дизайна**: не все заявки можно взять; это заставляет делать неудобные (интересные) выборы.
- **Все последствия видимы**: газета, конверты итогов, изменения на карте, реплики героев, фильтры/эффекты портретов.

---

## 5.2. Типы заявок и структура дня

**Типы заявок**:
1) **Обязательные магограммы** — сюжетные, всегда берутся; **ветвление зависит от выбранного героя** (и, позже, от его перков/хаос-стадии).
2) **Обычные заявки** — “экономика дня”: дают/отнимают **Репутацию** и **Золото**.
3) **Дуальные заявки** — задания вида “Красная шапочка / Волк”: **две конфликтующие стороны**, выбор определяет исход (может быть завязан на героя).

**Лимиты выбора (по умолчанию)**:
- В день есть **обязательная** заявка (если предусмотрено сюжетом) + **1–2 обычных/дуальных** (по конфигу дня).
- Если доступно больше заявок, часть остаётся **невыбранной** и уходит — это нормально, мир живёт дальше.

> **Срез для MVP (Раунды 1–4):** 1 — обучение/магограмма; 2 — базовые/экономические; 3 — магограмма + 1 из 2; изменение карты (Кладбище); 4 — откат дня и **обязательная** хаос-сцена в одной из заявок.

---

## 5.3. Модель исходов в прототипе (детерминированная)

На старте **нет общей вероятностной формулы**. Исход **жёстко привязан** к связке “Заявка × Исполнитель”. Пример (условный):

| Заявка                         | Лада | Тихон | Шлюмп |
|-------------------------------|:----:|:-----:|:-----:|
| Красная шапочка (девочка/волк)|  Успех  | Провал* | (скриптово) |
| Кладбище / Некромант          |  —   |  —    |  Успех (сюжет) |
| Канализация / Живоглот        |  Успех |  —    |  —    |

\* *Провал у Тихона в РШ — “провал с флагом”: девочка становится волчицей. Это провал экономически, но создаёт сюжетный след в мире.*

**Как расширяем дальше:** после MVP вводим перки → часть исходов становится **условной** (перки открывают альтернативные ветки магограммы и/или меняют исход).

---

## 5.4. Герои и “перки вместо характеристик”

Мы **отказываемся от классических характеристик** (Сила/Ловкость/Инт) и используем **перки** (как в Fallout). Перки:
- Описывают **уникальные ходы героя** и **гейтят ветки** в магограммах.
- В прототипе могут быть заскриптованы (перки как “теги доступа”).

**Примеры эскизов перков (для нарратива и гейта веток):**
- **Лада Укава**: “Лицензионная петля” (знает обходы/формулировки), “Элегантный допрос” (софт-прессинг), “Нелегальный проход” (тайные ходы).
- **Тихон**: “Форма 17-б” (протокол ради протокола), “Сухое слово” (deadpan-переговоры), “Служебный обход” (доступ к канцеляриям).
- **Шлюмп**: “Малая реанимация” (некро-подмога), “Медицинский протокол”, “Ядовитая бомба” (контролируемый вред во имя лечения).

**Реализация в JSON (схема, см. §5.10):** ветка магограммы может требовать `perk_id` у выбранного героя; без перка — ветка скрыта/заблокирована.

---

## 5.5. Хаос как персональная арка героя

**Хаос-метрика хранится на герое**, не глобально. Герой получает **метку хаоса** за:
- хаос-исход в заявке,
- участие в сюжетной “хаос-сцене” дня,
- выбор нестандартной ветки в магограмме (если она помечена как хаосовая).

**Стадии хаоса (рекомендация для прототипа):**
- **H0 — Норма**: портрет обычный, реплики базовые.
- **H1 — Сбой** (1–2 хаос-метки): лёгкий визуальный фильтр портрета, едкие реплики, **+1 альтернативная** ветка в магограммах.
- **H2 — Деформация** (3–4): явные визуальные изменения (аксессуары/тон), новые реплики, **бонус к доступу** в серых зонах закона, **минус к репутации** в “правильных” заданиях.
- **H3 — Разрыв** (5+): радикальная версия героя (вариант характера), возможна **блокировка** “правильных” веток и доступ к **уникальным хаос-веткам**. Риск **временного выбытия** в тяжёлых днях (см. День 7).

> **Важно:** числа — ориентиры. Фактическое продвижение к H2/H3 в прототипе — **скриптуется** по плану раундов (см. §5.8).

---

## 5.6. Ресурсы: Репутация и Золото

- **Репутация**: растёт/падает от обычных заявок и итогов магограмм. Влияет на тексты, реакции NPC, потенциально — на доступность некоторых заявок.
- **Золото**: даётся/отнимается заданиями. В прототипе — **фильтр доступа** к части заявок (районы “бедный/богатый”, налоги, пошлины).

> На MVP ресурсы — **простая математика** (+1/0/–1; ±2 на особых событиях). Точные числа вносим в правила заявок (TaskRule).

---

## 5.7. Ограничения выбора и ритм

- В каждый день действует лимит на число заявок: обязательные + ограниченное число обычных/дуальных.
- Часть заявок **исчезает**, если не взяты (мир живёт). Это создаёт **цену отказа**.
- Дуальные заявки подразумевают **жёсткий выбор стороны** (одна сторона будет недовольна).

---

## 5.8. Сценарные рельсы по раундам (для баланса хаоса)

- **Раунд 1** — знакомство, обучающая магограмма. Хаоса нет.
- **Раунд 2** — базовые заявки (экономика). Хаосовые метки не выдаём.
- **Раунд 3** — магограмма + 1 из 2; **изменение карты (Кладбище)**; возможна первая **хаос-метка** у Шлюмпа по сюжету некромантии.
- **Раунд 4** — **откат дня**; **обязательная хаос-сцена** в одной заявке (кто-то из базовых героев получает хаос-метку и видимые изменения).
- **Раунд 6** — обязательная магограмма с **новым героем** (по прошлым решениям); 2 обычных заявки. Игрок решает, брать ли героя с ярко выраженным хаосом.
- **Раунд 7** — **обязательная заявка с риском**: герой может **пострадать и временно/постоянно выбыть** (скриптово).
- **Раунд 8** — **катаклизм некромантии**: много мелких заявок, все выполнить невозможно. **Город пострадает** (флаги районов).
- **Раунд 9** — ещё больше заявок + **срочное сюжетное задание-магограмма** (устранить источник катаклизма).
- **Раунд 10** — **итоговые слайды** и подведение результатов прототипа.

> **MVP-срез на месяц**: реализуем **Раунды 1–4** полностью (с видимой персональной хаос-меткой в конце Р4).

---

## 5.9. Статусы героев и риски выбытия

Статусы:
- **Active** — доступен для выбора.
- **Shaken** — активен, но меняются реплики/портрет; может терять доступ к “правильным” веткам, получать доступ к хаос-веткам.
- **Disabled** — **временно недоступен** (после тяжёлых событий, напр. Р7).
- **Departed** — **покинул актив** (сюжетно/постоянно). Может остаться NPC.

В MVP статусы переводятся **скриптом сюжета** (см. раунды выше), не формулой.

---

## 5.10. Данные: TaskRule (JSON) — минимальная схема

```jsonc
{
  "notice_id": "R3_001_RED_WOLF",
  "type": "dual|mandatory|regular",
  "region_id": "CEMETERY",
  "requires_flags": ["CEMETERY_UNDER_CURSE"],
  "requires_gold_min": 0,
  "allowed_executors": ["LADA", "TIKHON", "SHLUMP"],
  "outcome_map": {
    "LADA": "SUCCESS",
    "TIKHON": "FAIL_FLAG_WOLF_GIRL",
    "SHLUMP": "LOCKED" // или SUCCESS/FAIL/CHAOS
  },
  "rewards": {
    "reputation": +1,
    "gold": 0
  },
  "sets_flags": ["WOLF_GIRL_CREATED"],
  "region_state_delta": { "CEMETERY": "CLEANSED" },
  "chaos_tags": {
    "LADA": 0,
    "TIKHON": 1,   // выбор Тихона даёт герою хаос-метку
    "SHLUMP": 0
  },
  "magogram": {
    "has_endings": true,
    "branches": [
      { "id": "A1", "requires_perk": "LADA_LICENSE_LOOP" },
      { "id": "B2", "requires_perk": null, "chaos": true }
    ]
  }
}
```

**Пояснения:**
- `outcome_map` — **ядро MVP**: детерминирует исход по герою.
- `chaos_tags[HERO]` → если 1, **добавить герою хаос-метку** после завершения.
- `magogram.branches[].requires_perk` — скрытые ветки без нужного перка.
- `region_state_delta` — изменение состояния района (для карты/газеты).
- `sets_flags` — флаги мира; `requires_flags` — условия показа/активации.

---

## 5.11. Балансные ориентиры (чтобы игра “дышала”)

- **На 1–3 раундах** почти не штрафуем игрока — знакомим и втягиваем.
- **К Р4** игрок должен **увидеть хаос-изменение** хотя бы у одного героя.
- **К Р7** хотя бы один герой должен **рисковать выбытием** (даже если это обходится).
- **К Р8–Р9** мир должен явно “ломаться” (карта/газета/реплики), чтобы финал ощущался заслуженным.
- **Репутация/Золото** — держим в диапазонах ±3–±6 за весь пробег прототипа; на Р8 возможны большие колебания (катаклизм).

---

## 5.12. Чек‑лист плейтестов баланса

- Игрок **понимает**, почему исход привязан к герою (UI/подсказки/реплики).
- Хаос **заметен** визуально и в тексте (портрет, реплики, ветки).
- Решения **болят**: не все заявки можно взять; отказ имеет последствия (газета/флаги).
- Карта/районы **меняются** к Р3–Р4 (минимум одно заметное изменение).
- **MVP 1–4**: есть обязательная магограмма, дуальная заявка, минимум одна хаос‑метка у героя.
